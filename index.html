<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vocabulary Trainer</title>
  <style>
    :root{
      --bg:#eef1f7;--card:#ffffff;--muted:#6b7280;--text:#111827;
      --primary:#4f46e5;--primary2:#4338ca;
      --soft:#f3f4f6;--soft2:#e5e7eb;
      --ok:#16a34a;--bad:#ef4444;
      --shadow:0 18px 40px rgba(17,24,39,.12);
      --radius:18px;
    }
    *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
    body{
      margin:0;background:var(--bg);color:var(--text);
      display:flex;justify-content:center;align-items:center;
      min-height:100vh;padding:20px;
    }
    .wrap{width:min(720px,96vw);}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px;}
    h1{text-align:center;margin:0 0 4px;font-size:28px;}
    .sub{text-align:center;color:var(--muted);font-size:14px;margin-bottom:16px;}
    .tabs{display:flex;gap:4px;background:var(--soft2);padding:4px;border-radius:999px;margin-bottom:14px;}
    .tab{flex:1;border:0;padding:10px;border-radius:999px;font-weight:700;cursor:pointer;}
    .tab.active{background:var(--primary);color:#fff;}
    .meta{display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:10px;}
    .pill{display:flex;gap:8px;font-weight:800;font-size:14px;}
    .badge{padding:4px 10px;border-radius:999px;background:var(--soft);}
    .badge.ok{background:#dcfce7;color:var(--ok);}
    .badge.bad{background:#fee2e2;color:var(--bad);}
    .badge.rate{background:#e0e7ff;color:var(--primary2);}
    select,input{padding:8px 10px;border-radius:10px;border:1px solid var(--soft2);}
    .btn{padding:10px 14px;border-radius:999px;border:0;cursor:pointer;font-weight:900;}
    .btn.primary{background:var(--primary);color:#fff;}
    .btn.ghost{background:transparent;border:1px solid var(--soft2);}
    .box{background:#f8fafc;border:1px solid var(--soft2);border-radius:16px;padding:14px;margin:12px 0;}
    .label{font-weight:800;margin-bottom:6px;}
    .prompt{font-size:18px;font-weight:800;}
    .answerArea{margin-top:12px;}
    .choices{display:grid;gap:10px;}
    .choice{padding:12px;border-radius:14px;border:1px solid var(--soft2);font-weight:800;cursor:pointer;}
    .choice.correct{background:#f0fdf4;border-color:#86efac;}
    .choice.wrong{background:#fef2f2;border-color:#fecaca;}
    .hr{height:1px;background:var(--soft2);margin:14px 0;}
    .small{font-size:13px;color:var(--muted);}
  </style>
</head>

<body>
<div class="wrap">
<div class="card">
<h1>Vocabulary Trainer</h1>
<p class="sub">— 自動載入題庫（無手動上傳）—</p>

<div class="tabs">
  <button id="tabC2E" class="tab active">中 ➜ 英 填空</button>
  <button id="tabE2C" class="tab">英 ➜ 中 四選一</button>
</div>

<div class="meta">
  <div class="pill">
    <span id="idxText">0 / 0</span>
    <select id="levelSelect"></select>
    <select id="countSelect">
      <option value="all">全部</option>
      <option value="10">10</option>
      <option value="20">20</option>
      <option value="50">50</option>
      <option value="100">100</option>
    </select>
    <button id="btnStart" class="btn ghost">開始 / 重置</button>
  </div>
  <div class="pill">
    <span id="okBadge" class="badge ok">0</span>
    <span id="badBadge" class="badge bad">0</span>
    <span id="rateBadge" class="badge rate">0%</span>
  </div>
</div>

<div class="box">
  <div class="label" id="promptLabel"></div>
  <div class="prompt" id="promptText">載入中…</div>
</div>

<div id="c2eArea" class="answerArea">
  <input id="textAnswer" placeholder="輸入英文後 Enter" />
  <button id="btnCheck1" class="btn primary">檢查</button>
  <button id="btnNext1" class="btn">下一題</button>
  <div id="feedback1" class="small"></div>
</div>

<div id="e2cArea" class="answerArea" style="display:none;">
  <div id="choices" class="choices"></div>
  <button id="btnNext2" class="btn">下一題</button>
  <div id="feedback2" class="small"></div>
</div>

<div class="hr"></div>
<button id="btnClearWrong" class="btn">清除錯題紀錄</button>

</div>
</div>

<script>
const DEFAULT_JSON = "./vocab_ceec_1_6.json";
let vocabCache=null,session=[],pool=[],idx=0,ok=0,bad=0,mode="C2E",locked=false;

const qs=id=>document.getElementById(id);
const tabC2E=qs("tabC2E"),tabE2C=qs("tabE2C");
const promptText=qs("promptText"),promptLabel=qs("promptLabel");
const levelSelect=qs("levelSelect"),countSelect=qs("countSelect");
const idxText=qs("idxText"),okBadge=qs("okBadge"),badBadge=qs("badBadge"),rateBadge=qs("rateBadge");
const c2eArea=qs("c2eArea"),e2cArea=qs("e2cArea");
const textAnswer=qs("textAnswer"),choices=qs("choices");
const feedback1=qs("feedback1"),feedback2=qs("feedback2");

function normalizeVocabCacheShape(raw){
  const out={};
  for(let i=1;i<=6;i++) out[`Level ${i}`]=[];
  raw.forEach(x=>{
    if(x.word && x.definition){
      const lv=parseInt(x.level||1,10);
      out[`Level ${lv}`].push(x);
    }
  });
  return out;
}

function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}

function buildSession(){
  const lv=levelSelect.value;
  pool=[...vocabCache[lv]];
  shuffle(pool);
  session=pool.slice(0,parseInt(countSelect.value)||pool.length);
  idx=0;ok=0;bad=0;
  render();
}

function render(){
  idxText.textContent=`${idx+1} / ${session.length}`;
  okBadge.textContent=ok;
  badBadge.textContent=bad;
  rateBadge.textContent=ok+bad?Math.round(ok/(ok+bad)*100)+"%":"0%";

  const it=session[idx];
  if(!it){promptText.textContent="結束";return;}

  if(mode==="C2E"){
    promptLabel.textContent="中文 / 解釋";
    promptText.textContent=it.definition;
  }else{
    promptLabel.textContent="英文";
    promptText.textContent=it.word;
    renderChoices(it);
  }
}

function renderChoices(it){
  choices.innerHTML="";
  const defs=shuffle(pool.map(x=>x.definition)).slice(0,3);
  const opts=shuffle([it.definition,...defs]);
  opts.forEach(o=>{
    const b=document.createElement("button");
    b.className="choice";b.textContent=o;
    b.onclick=()=>{
      if(o===it.definition){b.classList.add("correct");ok++;}
      else{b.classList.add("wrong");bad++;}
      render();
    };
    choices.appendChild(b);
  });
}

tabC2E.onclick=()=>{mode="C2E";c2eArea.style.display="";e2cArea.style.display="none";render();}
tabE2C.onclick=()=>{mode="E2C";c2eArea.style.display="none";e2cArea.style.display="";render();}

document.getElementById("btnStart").onclick=buildSession;
document.getElementById("btnNext1").onclick=()=>{idx++;render();}
document.getElementById("btnNext2").onclick=()=>{idx++;render();}
document.getElementById("btnCheck1").onclick=()=>{
  const it=session[idx];
  if(textAnswer.value.trim().toLowerCase()===it.word.toLowerCase()) ok++; else bad++;
  textAnswer.value=""; render();
};

fetch(DEFAULT_JSON).then(r=>r.json()).then(raw=>{
  vocabCache=normalizeVocabCacheShape(raw);
  Object.keys(vocabCache).forEach(lv=>{
    const o=document.createElement("option");o.value=lv;o.textContent=lv;
    levelSelect.appendChild(o);
  });
  promptText.textContent="✅ 題庫載入完成，請開始";
});
</script>
</body>
</html>
