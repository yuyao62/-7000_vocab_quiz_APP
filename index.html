<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vocabulary Trainer</title>
  <style>
    :root{
      --bg:#eef1f7;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#111827;
      --primary:#4f46e5;
      --primary2:#4338ca;
      --soft:#f3f4f6;
      --soft2:#e5e7eb;
      --ok:#16a34a;
      --bad:#ef4444;
      --shadow: 0 18px 40px rgba(17,24,39,.12);
      --radius:18px;
    }
    *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
    html,body{width:100%;max-width:100%;overflow-x:hidden;}
    body{
      margin:0; background:var(--bg); color:var(--text);
      display:flex; align-items:center; justify-content:center;
      min-height:100vh; padding:20px;
    }
    .wrap{width:min(720px, 96vw);}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px 22px 18px;
    }
    h1{
      margin:0 0 4px; text-align:center;
      font-size:28px; letter-spacing:.2px;
    }
    .sub{
      text-align:center; color:var(--muted);
      margin:0 0 16px; font-size:14px;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .tabs{margin:10px 0 14px; background:var(--soft2); border-radius:999px; padding:4px; display:flex; gap:4px;}
    .tab{
      flex:1; border:0; padding:10px 12px; border-radius:999px;
      background:transparent; cursor:pointer; font-weight:700;
      color:#374151; font-size:15px;
    }
    .tab.active{
      background:var(--primary);
      color:#fff;
      box-shadow:0 10px 20px rgba(79,70,229,.25);
    }
    .meta{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin:8px 0 10px;
    }
    .meta .left{display:flex; align-items:center; gap:12px; flex-wrap:wrap;}
    .meta label{color:#374151; font-weight:600; font-size:14px;}
    select, input[type="number"]{
      border:1px solid var(--soft2);
      border-radius:10px;
      padding:8px 10px;
      font-size:14px;
      background:#fff;
    }
    .pill{
      display:flex; align-items:center; gap:8px;
      font-weight:800; font-size:14px;
    }
    .badge{
      padding:4px 10px; border-radius:999px; background:var(--soft);
      font-weight:800; min-width:44px; text-align:center;
    }
    .badge.ok{background:#dcfce7; color:var(--ok);}
    .badge.bad{background:#fee2e2; color:var(--bad);}
    .badge.rate{background:#e0e7ff; color:var(--primary2);}
    .box{
      background:#f8fafc;
      border:1px solid var(--soft2);
      border-radius:16px;
      padding:14px 14px;
      margin:10px 0 12px;
      min-height:96px;
    }
    .box .label{color:#374151; font-weight:800; margin-bottom:6px;}

    /* âœ… é¡Œç›®æ¡†å­—é«”åŠ å¤§ */
    .prompt{
      font-size:22px;         /* åŸæœ¬ 18px */
      font-weight:900;
      line-height:1.35;
      white-space:pre-wrap;
    }

    .leveltag{
      display:inline-block; margin-top:10px;
      background:#dbeafe; color:#1d4ed8;
      padding:4px 10px; border-radius:999px;
      font-weight:900; font-size:13px;
    }
    .answerArea{margin-top:12px;}
    .inputline{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .textinput{
      flex:1; min-width:220px;
      border:1px solid var(--soft2); border-radius:12px;
      padding:10px 12px; font-size:16px;
    }
    .btn{
      border:0; cursor:pointer;
      padding:10px 14px;
      border-radius:999px;
      font-weight:900; font-size:15px;
      background:var(--soft2);
      color:#111827;
    }
    .btn.primary{
      background:var(--primary); color:#fff;
      box-shadow:0 10px 20px rgba(79,70,229,.22);
    }
    .btn.primary:hover{background:var(--primary2);}
    .btn.ghost{background:transparent; border:1px solid var(--soft2); color:#111827;}
    .btn:disabled{opacity:.5; cursor:not-allowed;}
    .choices{display:grid; gap:10px; margin-top:10px;}
    .choice{
      text-align:left;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--soft2);
      background:#fff;
      cursor:pointer;
      font-weight:800;
      font-size:16px;
    }
    .choice:hover{background:#f9fafb;}
    .choice.correct{border-color:#86efac; background:#f0fdf4;}
    .choice.wrong{border-color:#fecaca; background:#fef2f2;}
    .hr{height:1px;background:var(--soft2); margin:14px 0;}
    .tip{color:var(--muted); font-size:13px; text-align:center;}
    .small{color:var(--muted); font-size:13px;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>Vocabulary Trainer</h1>
      <p class="sub">â€” ä¸€éµåˆ‡æ›ï¼šä¸­ âœ è‹± å¡«ç©º / è‹± âœ ä¸­ å››é¸ä¸€ â€”</p>

      <div class="tabs">
        <button id="tabC2E" class="tab active">ä¸­ âœ è‹± å¡«ç©º</button>
        <button id="tabE2C" class="tab">è‹± âœ ä¸­ å››é¸ä¸€</button>
      </div>

      <div class="meta">
        <div class="left">
          <div class="pill">
            <span class="small">é¡Œç›®ï¼š</span>
            <span id="idxText" class="small">0 / 0</span>
          </div>

          <label>å‡ºé¡Œ Levelï¼š</label>
          <select id="levelSelect"></select>

          <label>é¡Œæ•¸ï¼š</label>
          <select id="countSelect">
            <option value="all">å…¨éƒ¨ï¼ˆæœ€å¤š 500ï¼‰</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="200">200</option>
            <option value="custom">è‡ªè¨‚ï¼ˆ1-500ï¼‰</option>
          </select>

          <input id="customCount" type="number" min="1" max="500" step="1" placeholder="1-500"
                 style="display:none;width:120px;" />

          <button id="btnStart" class="btn ghost">é–‹å§‹ / é‡ç½®</button>

          <!-- âœ… æ¸…é™¤éŒ¯é¡Œæ”¾ä¸Šæ–¹ -->
          <button id="btnClearWrong" class="btn">æ¸…é™¤éŒ¯é¡Œ</button>
        </div>

        <div class="pill">
          <span id="okBadge" class="badge ok">0</span>
          <span id="badBadge" class="badge bad">0</span>
          <span id="rateBadge" class="badge rate">0%</span>
        </div>
      </div>

      <div class="row small" style="justify-content:space-between;">
        <div>é¡Œåº«ï¼š<span id="poolSize">0</span> å­—</div>
        <div>æœ¬æ¬¡æ¸¬é©—ï¼š<span id="sessionSize">0</span> é¡Œ</div>
      </div>

      <div class="box">
        <div class="label" id="promptLabel">ä¸­æ–‡ / è§£é‡‹</div>
        <div class="prompt" id="promptText">è®€å–é¡Œåº«ä¸­â€¦</div>
        <div class="leveltag" id="levelTag" style="display:none;"></div>
      </div>

      <div id="c2eArea" class="answerArea">
        <div class="row" style="justify-content:space-between;">
          <div class="small">è«‹è¼¸å…¥è‹±æ–‡å–®å­—</div>
          <button id="btnShowAnswer1" class="btn">é¡¯ç¤ºç­”æ¡ˆ</button>
        </div>
        <div class="inputline">
          <input id="textAnswer" class="textinput" placeholder="è¼¸å…¥è‹±æ–‡å¾ŒæŒ‰ Enter æˆ–ã€Œæª¢æŸ¥ã€" />
          <button id="btnCheck1" class="btn primary">æª¢æŸ¥ç­”æ¡ˆ</button>
          <button id="btnNext1" class="btn">ä¸‹ä¸€é¡Œ</button>
        </div>
        <div id="feedback1" class="small" style="margin-top:10px;"></div>
      </div>

      <div id="e2cArea" class="answerArea" style="display:none;">
        <div class="row" style="justify-content:space-between;">
          <div class="small">è«‹å¾å››å€‹é¸é …ä¸­é¸å‡ºæ­£ç¢ºä¸­æ–‡/è§£é‡‹</div>
          <button id="btnShowAnswer2" class="btn">é¡¯ç¤ºç­”æ¡ˆ</button>
        </div>
        <div class="choices" id="choices"></div>
        <div class="row" style="margin-top:10px;">
          <button id="btnNext2" class="btn">ä¸‹ä¸€é¡Œ</button>
          <div id="feedback2" class="small"></div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="tip">Tipï¼šæœ¬é æœƒè‡ªå‹•è¼‰å…¥åŒå±¤çš„ vocab_ceec_1_6.jsonï¼›é¸ Level å¾Œæœƒè‡ªå‹•å¸¶å…¥å‡ºé¡Œï¼›å¡«ç©ºæ¨¡å¼å¯æŒ‰ Enter é€å‡ºï¼›å³ä¸Šå¯åˆ‡æ›æ¨¡å¼ / Level / é¡Œæ•¸ã€‚</div>
    </div>
  </div>

  <script>
    const DEFAULT_JSON = "./vocab_ceec_1_6.json";

    let vocabCache = null; // æœƒè¢«çµ±ä¸€æˆï¼š{ "Level 1":[...], ..., "Level 6":[...] }
    let mode = "C2E";

    let pool = [];
    let session = [];
    let idx = 0;
    let ok = 0, bad = 0;
    let locked = false;
    let finished = false; // å›ºå®šé¡Œæ•¸ï¼šåšåˆ°æœ€å¾Œå°±çµæŸ

    const tabC2E = document.getElementById("tabC2E");
    const tabE2C = document.getElementById("tabE2C");

    const levelSelect = document.getElementById("levelSelect");
    const countSelect = document.getElementById("countSelect");
    const customCount = document.getElementById("customCount");
    const btnStart = document.getElementById("btnStart");
    const btnClearWrong = document.getElementById("btnClearWrong");

    const idxText = document.getElementById("idxText");
    const okBadge = document.getElementById("okBadge");
    const badBadge = document.getElementById("badBadge");
    const rateBadge = document.getElementById("rateBadge");

    const poolSize = document.getElementById("poolSize");
    const sessionSize = document.getElementById("sessionSize");

    const promptLabel = document.getElementById("promptLabel");
    const promptText = document.getElementById("promptText");
    const levelTag = document.getElementById("levelTag");

    const c2eArea = document.getElementById("c2eArea");
    const e2cArea = document.getElementById("e2cArea");

    const textAnswer = document.getElementById("textAnswer");
    const btnCheck1 = document.getElementById("btnCheck1");
    const btnNext1 = document.getElementById("btnNext1");
    const btnShowAnswer1 = document.getElementById("btnShowAnswer1");
    const feedback1 = document.getElementById("feedback1");

    const choices = document.getElementById("choices");
    const btnNext2 = document.getElementById("btnNext2");
    const btnShowAnswer2 = document.getElementById("btnShowAnswer2");
    const feedback2 = document.getElementById("feedback2");

    function normalizeItem(item){
      if(!item || typeof item !== "object") return null;

      const word = (item.word || item.Word || "").trim();
      let defRaw = (item.definition || item.answer || item.Definition || "").trim();
      let ipa = (item.ipa || item.IPA || "").trim();

      if(!word || !defRaw) return null;

      const m = defRaw.match(/^\s*\[([^\]]+)\]\s*(.*)$/);
      if(m){
        const ipaFromDef = `[${m[1].trim()}]`;
        const rest = (m[2] || "").trim();
        if(!ipa) ipa = ipaFromDef;
        defRaw = rest;
      }
      const definition = defRaw.trim();
      if(!definition) return null;

      return { word, definition, ipa };
    }

    function normalizeVocabCacheShape(raw){
      if(raw && typeof raw === "object" && !Array.isArray(raw)){
        const keys = Object.keys(raw);
        const hasLevelKey = keys.some(k => /^Level\s*\d+$/i.test(k));
        if(hasLevelKey) return raw;

        const maybeArr = raw.data || raw.items || raw.vocab || null;
        if(Array.isArray(maybeArr)){
          raw = maybeArr;
        }else{
          return {};
        }
      }

      if(Array.isArray(raw)){
        const out = {};
        for(let i=1;i<=6;i++) out[`Level ${i}`] = [];

        raw.forEach(obj => {
          const nv = normalizeItem(obj);
          if(!nv) return;

          const lvRaw = obj.level ?? obj.Level ?? obj.lv ?? obj.LV ?? obj.level_no ?? obj.levelNo ?? obj.LevelNo;
          const lvNum = parseInt(lvRaw, 10);

          if(lvNum >= 1 && lvNum <= 6){
            out[`Level ${lvNum}`].push(nv);
          }else{
            out["Level 1"].push(nv);
          }
        });

        return out;
      }

      return {};
    }

    function showWordWithIpa(word, ipa){
      const w = (word || "").trim();
      const i = (ipa || "").trim();
      return (w && i) ? `${w} ${i}` : w;
    }

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function clampInt(n, min, max){
      n = parseInt(n,10);
      if(isNaN(n)) return min;
      return Math.max(min, Math.min(max, n));
    }

    function updateScoreUI(){
      okBadge.textContent = ok;
      badBadge.textContent = bad;
      const total = ok + bad;
      const rate = total ? Math.round((ok/total)*100) : 0;
      rateBadge.textContent = `${rate}%`;
    }

    function updateIndexUI(){
      idxText.textContent = `${session.length ? (idx+1) : 0} / ${session.length}`;
      poolSize.textContent = pool.length;
      sessionSize.textContent = session.length;
    }

    function currentItem(){
      if(!session.length) return null;
      return session[idx];
    }

    function saveWrong(item){
      const key = "vt_wrong";
      let list = [];
      try{ list = JSON.parse(localStorage.getItem(key) || "[]"); }catch(e){ list = []; }
      if(!list.some(x => x && x.word === item.word)){
        list.push({word:item.word, definition:item.definition, ipa:item.ipa || ""});
      }
      localStorage.setItem(key, JSON.stringify(list));
    }

    function clearWrong(){
      localStorage.removeItem("vt_wrong");
    }

    function getDesiredCount(){
      const v = countSelect.value;
      const maxAllowed = Math.min(pool.length, 500);

      if(v === "all") return maxAllowed;
      if(v === "custom"){
        const c = clampInt(customCount.value, 1, maxAllowed);
        return c;
      }
      return clampInt(v, 1, maxAllowed);
    }

    function setFinishedUI(isFinished){
      finished = isFinished;

      btnNext1.disabled = finished;
      btnNext2.disabled = finished;

      textAnswer.disabled = finished;
      btnCheck1.disabled = finished;

      if(mode === "E2C"){
        [...choices.children].forEach(b => b.disabled = finished);
      }

      if(finished){
        const total = ok + bad;
        const rate = total ? Math.round((ok/total)*100) : 0;
        const msg = `ğŸ‰ æ¸¬é©—çµæŸï¼å…± ${session.length} é¡Œï¼Œç­”å° ${ok} é¡Œï¼Œæ­£ç¢ºç‡ ${rate}%ã€‚\næŒ‰ã€Œé–‹å§‹ / é‡ç½®ã€å¯é‡æ–°æŠ½é¡Œã€‚`;
        if(mode === "C2E") feedback1.textContent = msg;
        else feedback2.textContent = msg;
      }
    }

    function buildSession(){
      if(!vocabCache){
        alert("é¡Œåº«å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å€™ã€‚");
        return;
      }

      const lv = levelSelect.value;
      const rawList = (vocabCache[lv] || []);
      pool = rawList.map(normalizeItem).filter(Boolean);

      const n = getDesiredCount();
      session = shuffle([...pool]).slice(0, n);

      idx = 0;
      ok = 0;
      bad = 0;
      locked = false;

      feedback1.textContent = "";
      feedback2.textContent = "";

      updateScoreUI();
      updateIndexUI();
      renderQuestion();
      setFinishedUI(false);
    }

    function renderQuestion(){
      updateIndexUI();
      locked = false;

      const it = currentItem();
      if(!it){
        promptLabel.textContent = "æç¤º";
        promptText.textContent = "ç›®å‰æ²’æœ‰é¡Œç›®ï¼ˆå¯èƒ½è©² Level æ²’è³‡æ–™ï¼Œæˆ– JSON æ ¼å¼ä¸å« Levelï¼‰ã€‚";
        levelTag.style.display = "none";
        choices.innerHTML = "";
        setFinishedUI(true);
        return;
      }

      levelTag.style.display = "inline-block";
      levelTag.textContent = levelSelect.value;

      if(mode === "C2E"){
        promptLabel.textContent = "ä¸­æ–‡ / è§£é‡‹";
        promptText.textContent = it.definition;
        textAnswer.value = "";
        textAnswer.disabled = false;
        btnCheck1.disabled = false;
        textAnswer.focus();
      }else{
        promptLabel.textContent = "è‹±æ–‡ï¼ˆå«éŸ³æ¨™ï¼‰";
        promptText.textContent = showWordWithIpa(it.word, it.ipa);
        renderChoices(it);
      }
    }

    function renderChoices(it){
      choices.innerHTML = "";
      feedback2.textContent = "";

      const correct = it.definition;
      const candidates = pool.map(x => x.definition).filter(d => d && d !== correct);
      shuffle(candidates);
      const distractors = candidates.slice(0, Math.min(3, candidates.length));
      const opts = shuffle([correct, ...distractors]);

      opts.forEach((opt) => {
        const btn = document.createElement("button");
        btn.className = "choice";
        btn.textContent = opt;
        btn.onclick = () => {
          if(finished) return;
          if(locked) return;
          locked = true;

          if(opt === correct){
            btn.classList.add("correct");
            ok++;
            feedback2.textContent = "âœ… æ­£ç¢ºï¼";
          }else{
            btn.classList.add("wrong");
            bad++;
            feedback2.textContent = `âŒ éŒ¯èª¤ï¼Œæ­£ç¢ºç­”æ¡ˆï¼š${correct}`;
            saveWrong(it);
            [...choices.children].forEach(b=>{
              if(b.textContent === correct) b.classList.add("correct");
            });
          }
          updateScoreUI();
        };
        choices.appendChild(btn);
      });
    }

    function setMode(next){
      mode = next;
      tabC2E.classList.toggle("active", mode==="C2E");
      tabE2C.classList.toggle("active", mode==="E2C");
      c2eArea.style.display = (mode==="C2E") ? "" : "none";
      e2cArea.style.display = (mode==="E2C") ? "" : "none";
      feedback1.textContent = "";
      feedback2.textContent = "";
      renderQuestion();
      setFinishedUI(finished);
    }

    tabC2E.onclick = () => setMode("C2E");
    tabE2C.onclick = () => setMode("E2C");

    countSelect.onchange = () => {
      const v = countSelect.value;
      customCount.style.display = (v === "custom") ? "" : "none";
      if(v === "custom" && !customCount.value) customCount.value = "100";

      // è‹¥å·²è¼‰å…¥é¡Œåº«ï¼Œå°±ç«‹åˆ»ä¾æ–°é¡Œæ•¸é‡æŠ½ï¼ˆé«”æ„Ÿæ›´é †ï¼‰
      if(vocabCache) buildSession();
    };

    customCount.addEventListener("input", () => {
      const v = clampInt(customCount.value, 1, 500);
      customCount.value = String(v);

      // è‡ªè¨‚é¡Œæ•¸æ”¹äº†å°±é‡æŠ½
      if(countSelect.value === "custom" && vocabCache) buildSession();
    });

    btnStart.onclick = () => buildSession();

    function checkC2E(){
      if(finished) return;
      const it = currentItem();
      if(!it) return;

      const ans = (textAnswer.value || "").trim();
      if(!ans){
        feedback1.textContent = "è«‹å…ˆè¼¸å…¥ç­”æ¡ˆ";
        return;
      }

      if(ans.toLowerCase() === it.word.toLowerCase()){
        ok++;
        feedback1.textContent = "âœ… æ­£ç¢ºï¼";
      }else{
        bad++;
        feedback1.textContent = `âŒ éŒ¯èª¤ï¼Œæ­£ç¢ºç­”æ¡ˆï¼š${showWordWithIpa(it.word, it.ipa)}`;
        saveWrong(it);
      }
      updateScoreUI();
    }

    btnCheck1.onclick = checkC2E;
    textAnswer.addEventListener("keydown",(e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        checkC2E();
      }
    });

    btnShowAnswer1.onclick = () => {
      if(finished) return;
      const it = currentItem();
      if(!it) return;
      feedback1.textContent = `âœ… ç­”æ¡ˆï¼š${showWordWithIpa(it.word, it.ipa)}`;
    };

    btnShowAnswer2.onclick = () => {
      if(finished) return;
      const it = currentItem();
      if(!it) return;
      feedback2.textContent = `âœ… ç­”æ¡ˆï¼š${it.definition}`;
      [...choices.children].forEach(b=>{
        if(b.textContent === it.definition) b.classList.add("correct");
      });
      locked = true;
    };

    function nextQuestion(){
      if(finished) return;
      if(!session.length) return;

      if(idx >= session.length - 1){
        setFinishedUI(true);
        return;
      }

      idx += 1;
      feedback1.textContent = "";
      feedback2.textContent = "";
      renderQuestion();
    }

    btnNext1.onclick = nextQuestion;
    btnNext2.onclick = nextQuestion;

    function populateLevels(){
      levelSelect.innerHTML = "";
      const keys = Object.keys(vocabCache || {});

      const levels = keys
        .filter(k => /^Level\s*\d+$/i.test(k))
        .sort((a,b)=>{
          const na = parseInt(a.replace(/[^\d]/g,""),10);
          const nb = parseInt(b.replace(/[^\d]/g,""),10);
          return (na||0)-(nb||0);
        });

      const finalList = levels.length ? levels : keys;

      finalList.forEach(lv=>{
        const opt = document.createElement("option");
        opt.value = lv;
        opt.textContent = lv;
        levelSelect.appendChild(opt);
      });

      if(finalList.includes("Level 4")) levelSelect.value = "Level 4";
      else if(finalList.length) levelSelect.value = finalList[0];
    }

    async function autoLoadDefaultJson(){
      try{
        const res = await fetch(DEFAULT_JSON, { cache: "no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);

        const raw = await res.json();
        vocabCache = normalizeVocabCacheShape(raw);

        populateLevels();
        promptText.textContent = "âœ… å·²è‡ªå‹•è¼‰å…¥é¡Œåº«ï¼è«‹é¸ Level/é¡Œæ•¸ï¼ˆæˆ–ç›´æ¥æŒ‰é–‹å§‹ï¼‰";
        levelTag.style.display = "none";

        pool = [];
        session = [];
        idx = 0; ok = 0; bad = 0; locked = false;
        updateScoreUI();
        updateIndexUI();
        setFinishedUI(false);

        console.log("Loaded levels:", Object.keys(vocabCache));
      }catch(e){
        console.error("autoLoadDefaultJson failed:", e);
        promptText.textContent = "âš ï¸ è‡ªå‹•è¼‰å…¥é¡Œåº«å¤±æ•—ï¼šè«‹ç¢ºèª vocab_ceec_1_6.json èˆ‡ index.html åŒå±¤ã€‚";
      }
    }

    // âœ… é€™è£¡æ˜¯ä½ è¦çš„é—œéµï¼šé¸ Level å°±è‡ªå‹•å‡ºé¡Œï¼ˆä¸ç”¨æŒ‰é–‹å§‹ï¼‰
    levelSelect.onchange = () => {
      if(!vocabCache) return;
      buildSession();
    };

    btnClearWrong.onclick = () => {
      clearWrong();
      alert("å·²æ¸…é™¤éŒ¯é¡Œç´€éŒ„ï¼ˆlocalStorageï¼‰");
    };

    updateScoreUI();
    updateIndexUI();
    autoLoadDefaultJson();
  </script>
</body>
</html>
